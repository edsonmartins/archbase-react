import * as demos from '../../../demos/components/editors';

# ArchbaseCronExpressionEdit

O `ArchbaseCronExpressionEdit` é um componente para edição de expressões cron com editor visual através de modal, ideal para configurar tarefas agendadas e jobs recorrentes.

## Importação

```tsx
import { ArchbaseCronExpressionEdit } from '@archbase/components';
```

## Uso Básico

Editor de expressão cron com modal para configuração visual.

<Demo data={demos.cronExpressionEditUsage} />

### Como funciona

O componente fornece:
- **Campo readonly**: Exibe a expressão cron atual
- **Editor visual**: Modal com editor de expressão cron
- **Build de expressão**: Interface para construir expressões complexas
- **Validação**: Verifica sintaxe da expressão

```tsx
const [value, setValue] = useState<string>('0 0 * * *');

<ArchbaseCronExpressionEdit
  label="Expressão Cron"
  value={value}
  onChange={setValue}
  placeholder="Digite a expressão cron..."
/>
```

## Estados

Diferentes estados e configurações do componente.

<Demo data={demos.cronExpressionEditStates} />

### Expressões comuns

```tsx
// Diariamente à meia-noite
<ArchbaseCronExpressionEdit
  value="0 0 * * *"
  onChange={setValue}
/>

// Semanalmente no domingo à meia-noite
<ArchbaseCronExpressionEdit
  value="0 0 * * 0"
  onChange={setValue}
/>

// A cada hora
<ArchbaseCronExpressionEdit
  value="0 * * * *"
  onChange={setValue}
/>
```

### Somente leitura

```tsx
<ArchbaseCronExpressionEdit
  label="Expressão Cron"
  value={value}
  onChange={setValue}
  readOnly
/>
```

## Formato da Expressão Cron

### Estrutura

```
┌───────────── minuto (0 - 59)
│ ┌─────────── hora (0 - 23)
│ │ ┌────────── dia do mês (1 - 31)
│ │ │ ┌──────── mês (1 - 12)
│ │ │ │ ┌────── dia da semana (0 - 7, domingo = 0 ou 7)
│ │ │ │ │
* * * * *
```

### Campos

| Campo | Valores | Caracteres especiais |
|-------|---------|---------------------|
| Minuto | 0-59 | `*` `,` `-` `/` |
| Hora | 0-23 | `*` `,` `-` `/` |
| Dia do mês | 1-31 | `*` `,` `-` `/` `?` `L` `W` |
| Mês | 1-12 | `*` `,` `-` `/` |
| Dia da semana | 0-7 | `*` `,` `-` `/` `?` `L` `#` |

### Caracteres especiais

| Caractere | Descrição | Exemplo |
|-----------|-----------|---------|
| `*` | Todos os valores | `*` (todos os minutos) |
| `,` | Lista de valores | `1,3,5` (minutos 1, 3 e 5) |
| `-` | Intervalo | `1-5` (de 1 a 5) |
| `/` | Passo/Incremento | `*/5` (a cada 5) |
| `?` | Valor não específico | `?` (dia do mês ou semana) |
| `L` | Último | `L` (último dia do mês) |
| `W` | Dia da semana mais próximo | `15W` (dia 15 ou weekday mais próximo) |
| `#` | N-ésimo dia da semana | `1#2` (segunda segunda-feira) |

## Casos de Uso

### Tarefas diárias

```tsx
// Backup diário às 3h da manhã
const [backupCron, setBackupCron] = useState<string>('0 3 * * *');

<ArchbaseCronExpressionEdit
  label="Backup Diário"
  value={backupCron}
  onChange={setBackupCron}
/>
```

### Tarefas semanais

```tsx
// Relatório semanal toda segunda às 9h
const [reportCron, setReportCron] = useState<string>('0 9 * * 1');

<ArchbaseCronExpressionEdit
  label="Relatório Semanal"
  value={reportCron}
  onChange={setReportCron}
/>
```

### Tarefas mensais

```tsx
// Manutenção mensal no dia 1 à meia-noite
const [maintenanceCron, setMaintenanceCron] = useState<string>('0 0 1 * *');

<ArchbaseCronExpressionEdit
  label="Manutenção Mensal"
  value={maintenanceCron}
  onChange={setMaintenanceCron}
/>
```

### Tarefas frequentes

```tsx
// Sincronização a cada 15 minutos
const [syncCron, setSyncCron] = useState<string>('*/15 * * * *');

<ArchbaseCronExpressionEdit
  label="Sincronização"
  value={syncCron}
  onChange={setSyncCron}
/>
```

### Horário comercial

```tsx
// De segunda a sexta, a cada hora das 9h às 18h
const [businessCron, setBusinessCron] = useState<string>('0 9-18 * * 1-5');

<ArchbaseCronExpressionEdit
  label="Horário Comercial"
  value={businessCron}
  onChange={setBusinessCron}
/>
```

## Integração com Formulários

### Com React Hook Form

```tsx
import { useForm, Controller } from 'react-hook-form';

function ScheduledTaskForm() {
  const { control, handleSubmit } = useForm({
    defaultValues: {
      nome: '',
      descricao: '',
      cronExpression: '0 0 * * *'
    },
  });

  return (
    <form onSubmit={handleSubmit(onSubmit)}>
      <Controller
        name="cronExpression"
        control={control}
        render={({ field }) => (
          <ArchbaseCronExpressionEdit
            label="Agendamento"
            value={field.value}
            onChange={field.onChange}
          />
        )}
      />
    </form>
  );
}
```

### Com formulário de configuração

```tsx
function SystemConfig() {
  const [tasks, setTasks] = useState([
    { id: '1', nome: 'Backup', cron: '0 3 * * *' },
    { id: '2', nome: 'Cleanup', cron: '0 2 * * 0' },
  ]);

  return (
    <Stack>
      {tasks.map(task => (
        <ArchbaseCronExpressionEdit
          key={task.id}
          label={task.nome}
          value={task.cron}
          onChange={(cron) => setTasks(prev =>
            prev.map(t => t.id === task.id ? { ...t, cron } : t)
          )}
        />
      ))}
    </Stack>
  );
}
```

## Validação

### Validar formato

```tsx
function validarCronExpressao(cron: string): boolean {
  const partes = cron.trim().split(/\s+/);
  if (partes.length !== 5) return false;

  const [minuto, hora, diaMes, mes, diaSemana] = partes;

  // Validação básica
  const validNumero = (val: string, min: number, max: number) => {
    if (val === '*') return true;
    const num = parseInt(val);
    return !isNaN(num) && num >= min && num <= max;
  };

  return (
    validNumero(minuto, 0, 59) &&
    validNumero(hora, 0, 23) &&
    validNumero(diaMes, 1, 31) &&
    validNumero(mes, 1, 12) &&
    validNumero(diaSemana, 0, 7)
  );
}
```

### Com mensagem de erro

```tsx
function ComValidacao() {
  const [value, setValue] = useState<string>('');
  const [error, setError] = useState<string>();

  const handleChange = (newValue: string) => {
    setValue(newValue);

    if (!validarCronExpressao(newValue)) {
      setError('Expressão cron inválida');
    } else {
      setError(undefined);
    }
  };

  return (
    <ArchbaseCronExpressionEdit
      label="Expressão Cron"
      value={value}
      onChange={handleChange}
      error={error}
    />
  );
}
```

## Expressões Comuns

### Frequência

| Descrição | Expressão |
|-----------|-----------|
| A cada minuto | `* * * * *` |
| A cada hora | `0 * * * *` |
| Meia-noite diária | `0 0 * * *` |
| Meio-dia diária | `0 12 * * *` |
| Às 9h da manhã | `0 9 * * *` |

### Dias da semana

| Descrição | Expressão |
|-----------|-----------|
| Segunda-feira | `0 0 * * 1` |
| Sexta-feira | `0 0 * * 5` |
| Segunda a sexta | `0 0 * * 1-5` |
| Fim de semana | `0 0 * * 0,6` |

### Mês

| Descrição | Expressão |
|-----------|-----------|
| Dia 1 do mês | `0 0 1 * *` |
| Dia 15 do mês | `0 0 15 * *` |
| Último dia do mês | `0 0 L * *` |
| Primeira segunda-feira | `0 0 * * 1#1` |

### Intervalos

| Descrição | Expressão |
|-----------|-----------|
| A cada 5 minutos | `*/5 * * * *` |
| A cada 2 horas | `0 */2 * * *` |
| A cada 10 dias | `0 0 */10 * *` |
| De segunda a sexta às 9h | `0 9 * * 1-5` |

## Acessibilidade

O componente segue as melhores práticas de acessibilidade:
- Labels associados corretamente
- Suporte a navegação por teclado
- Modal acessível com foco management
- Compatível com screen readers

## API

### Props

| Prop | Tipo | Padrão | Descrição |
|------|------|--------|-----------|
| `value` | `string` | **Obrigatório** | Expressão cron atual |
| `onChange` | `(newValue: string) => void` | **Obrigatório** | Callback quando expressão muda |
| `label` | `string` | - | Label do campo |
| `placeholder` | `string` | "Expressão Cron" | Placeholder do campo |
| `readOnly` | `boolean` | `false` | Desabilita edição |
| `error` | `string` | - | Mensagem de erro |

## Dicas

### Debug de expressões

```tsx
// Use ferramentas online para validar e testar expressões
// https://crontab.guru/
// https://cronexpression.herokuapp.com/

const [cron, setCron] = useState<string>('0 0 * * *');

useEffect(() => {
  // Log para debug
  console.log('Expressão cron:', cron);
}, [cron]);
```

### Expressões predefinidas

```tsx
const CRON_PRESETS = {
  HOURLY: '0 * * * *',
  DAILY: '0 0 * * *',
  WEEKLY: '0 0 * * 0',
  MONTHLY: '0 0 1 * *',
  YEARLY: '0 0 1 1 *',
};

function PresetSelector({ value, onChange }) {
  return (
    <Select
      label="Predefinição"
      data={[
        { value: CRON_PRESETS.HOURLY, label: 'A cada hora' },
        { value: CRON_PRESETS.DAILY, label: 'Diariamente' },
        { value: CRON_PRESETS.WEEKLY, label: 'Semanalmente' },
        { value: CRON_PRESETS.MONTHLY, label: 'Mensalmente' },
      ]}
      value={value}
      onChange={onChange}
    />
  );
}
```

### Preview da próxima execução

```tsx
import cronParser from 'cron-parser';

function ProximaExecucao({ cronExpression }) {
  try {
    const interval = cronParser.parseExpression(cronExpression);
    const next = interval.next().toDate();

    return (
      <Text size="sm">
        Próxima execução: {next.toLocaleString('pt-BR')}
      </Text>
    );
  } catch (err) {
    return <Text size="sm" c="red">Expressão inválida</Text>;
  }
}
```

## Compatibilidade

O componente segue o padrão cron Linux/Linux/Unix, compatível com:
- Cron jobs Linux
- Agendações de sistemas como Kubernetes, Airflow, etc.
- Bibliotecas como node-cron, agenda, etc.
