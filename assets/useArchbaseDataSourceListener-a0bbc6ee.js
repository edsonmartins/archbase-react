import{i as a}from"./i18next-a4b2730f.js";import{l as R}from"./lodash-4d0be66a.js";import{i as w,p as E}from"./index-1905cc86.js";import{r as D}from"./index-8b3efc3f.js";var v={exports:{}},u=typeof Reflect=="object"?Reflect:null,y=u&&typeof u.apply=="function"?u.apply:function(e,t,i){return Function.prototype.apply.call(e,t,i)},g;u&&typeof u.ownKeys=="function"?g=u.ownKeys:Object.getOwnPropertySymbols?g=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:g=function(e){return Object.getOwnPropertyNames(e)};function B(r){console&&console.warn&&console.warn(r)}var x=Number.isNaN||function(e){return e!==e};function d(){d.init.call(this)}v.exports=d;v.exports.once=M;d.EventEmitter=d;d.prototype._events=void 0;d.prototype._eventsCount=0;d.prototype._maxListeners=void 0;var b=10;function m(r){if(typeof r!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof r)}Object.defineProperty(d,"defaultMaxListeners",{enumerable:!0,get:function(){return b},set:function(r){if(typeof r!="number"||r<0||x(r))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+r+".");b=r}});d.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};d.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||x(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function I(r){return r._maxListeners===void 0?d.defaultMaxListeners:r._maxListeners}d.prototype.getMaxListeners=function(){return I(this)};d.prototype.emit=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var s=e==="error",n=this._events;if(n!==void 0)s=s&&n.error===void 0;else if(!s)return!1;if(s){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var c=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw c.context=o,c}var l=n[e];if(l===void 0)return!1;if(typeof l=="function")y(l,this,t);else for(var f=l.length,F=T(l,f),i=0;i<f;++i)y(F[i],this,t);return!0};function L(r,e,t,i){var s,n,o;if(m(t),n=r._events,n===void 0?(n=r._events=Object.create(null),r._eventsCount=0):(n.newListener!==void 0&&(r.emit("newListener",e,t.listener?t.listener:t),n=r._events),o=n[e]),o===void 0)o=n[e]=t,++r._eventsCount;else if(typeof o=="function"?o=n[e]=i?[t,o]:[o,t]:i?o.unshift(t):o.push(t),s=I(r),s>0&&o.length>s&&!o.warned){o.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=r,c.type=e,c.count=o.length,B(c)}return r}d.prototype.addListener=function(e,t){return L(this,e,t,!1)};d.prototype.on=d.prototype.addListener;d.prototype.prependListener=function(e,t){return L(this,e,t,!0)};function P(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function A(r,e,t){var i={fired:!1,wrapFn:void 0,target:r,type:e,listener:t},s=P.bind(i);return s.listener=t,i.wrapFn=s,s}d.prototype.once=function(e,t){return m(t),this.on(e,A(this,e,t)),this};d.prototype.prependOnceListener=function(e,t){return m(t),this.prependListener(e,A(this,e,t)),this};d.prototype.removeListener=function(e,t){var i,s,n,o,c;if(m(t),s=this._events,s===void 0)return this;if(i=s[e],i===void 0)return this;if(i===t||i.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete s[e],s.removeListener&&this.emit("removeListener",e,i.listener||t));else if(typeof i!="function"){for(n=-1,o=i.length-1;o>=0;o--)if(i[o]===t||i[o].listener===t){c=i[o].listener,n=o;break}if(n<0)return this;n===0?i.shift():_(i,n),i.length===1&&(s[e]=i[0]),s.removeListener!==void 0&&this.emit("removeListener",e,c||t)}return this};d.prototype.off=d.prototype.removeListener;d.prototype.removeAllListeners=function(e){var t,i,s;if(i=this._events,i===void 0)return this;if(i.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):i[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete i[e]),this;if(arguments.length===0){var n=Object.keys(i),o;for(s=0;s<n.length;++s)o=n[s],o!=="removeListener"&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=i[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(s=t.length-1;s>=0;s--)this.removeListener(e,t[s]);return this};function O(r,e,t){var i=r._events;if(i===void 0)return[];var s=i[e];return s===void 0?[]:typeof s=="function"?t?[s.listener||s]:[s]:t?N(s):T(s,s.length)}d.prototype.listeners=function(e){return O(this,e,!0)};d.prototype.rawListeners=function(e){return O(this,e,!1)};d.listenerCount=function(r,e){return typeof r.listenerCount=="function"?r.listenerCount(e):C.call(r,e)};d.prototype.listenerCount=C;function C(r){var e=this._events;if(e!==void 0){var t=e[r];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}d.prototype.eventNames=function(){return this._eventsCount>0?g(this._events):[]};function T(r,e){for(var t=new Array(e),i=0;i<e;++i)t[i]=r[i];return t}function _(r,e){for(;e+1<r.length;e++)r[e]=r[e+1];r.pop()}function N(r){for(var e=new Array(r.length),t=0;t<e.length;++t)e[t]=r[t].listener||r[t];return e}function M(r,e){return new Promise(function(t,i){function s(o){r.removeListener(e,n),i(o)}function n(){typeof r.removeListener=="function"&&r.removeListener("error",s),t([].slice.call(arguments))}S(r,e,n,{once:!0}),e!=="error"&&$(r,s,{once:!0})})}function $(r,e,t){typeof r.on=="function"&&S(r,"error",e,t)}function S(r,e,t,i){if(typeof r.on=="function")i.once?r.once(e,t):r.on(e,t);else if(typeof r.addEventListener=="function")r.addEventListener(e,function s(n){i.once&&r.removeEventListener(e,s),t(n)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof r)}var V=v.exports;class J extends Error{constructor(e){super(e),this.name="ArchbaseError"}}class h extends Error{constructor(e){super(e),this.name="ArchbaseDataSourceError"}}class z{getNestedProperty(e,t){return e&&typeof e=="object"?typeof t=="string"&&t!==""?t.split(".").reduce((s,n)=>s&&s[n],e):typeof t=="number"?e[t]:e:e}hasNestedProperty(e,t,i){return i=i||{},e&&typeof e=="object"?typeof t=="string"&&t!==""?t.split(".").reduce((n,o,c,l)=>c===l.length-1?i.own?!!(n&&n.hasOwnProperty(o)):n!==null&&typeof n=="object"&&o in n:n&&n[o],e):typeof t=="number"?t in e:!1:!1}setNestedProperty(e,t,i){if(e&&typeof e=="object"){if(typeof t=="string"&&t!==""){const s=t.split(".");return s.reduce((n,o,c)=>(n[o]=n[o]||{},s.length===c+1&&(n[o]=i),n[o]),e)}return typeof t=="number"?(e[t]=i,e[t]):e}return e}isInNestedProperty(e,t,i,s){if(s=s||{},e&&typeof e=="object"){if(typeof t=="string"&&t!==""){const n=t.split(".");let o=!1;const c=!!n.reduce((l,f)=>(o=o||l===i||!!l&&l[f]===i,l&&l[f]),e);return s.validPath?o&&c:o}return!1}return!1}isEmpty(e){for(const t in e)if(e.hasOwnProperty(t))return!1;return!0}}const p=new z;var G=(r=>(r[r.dataChanged=0]="dataChanged",r[r.recordChanged=1]="recordChanged",r[r.refreshData=2]="refreshData",r[r.fieldChanged=3]="fieldChanged",r[r.beforeClose=4]="beforeClose",r[r.afterClose=5]="afterClose",r[r.beforeOpen=6]="beforeOpen",r[r.afterOpen=7]="afterOpen",r[r.beforeAppend=8]="beforeAppend",r[r.afterAppend=9]="afterAppend",r[r.beforeRemove=10]="beforeRemove",r[r.afterRemove=11]="afterRemove",r[r.beforeInsert=12]="beforeInsert",r[r.afterInsert=13]="afterInsert",r[r.beforeEdit=14]="beforeEdit",r[r.afterEdit=15]="afterEdit",r[r.beforeSave=16]="beforeSave",r[r.afterSave=17]="afterSave",r[r.beforeCancel=18]="beforeCancel",r[r.afterCancel=19]="afterCancel",r[r.afterScroll=20]="afterScroll",r[r.onError=21]="onError",r[r.onFieldError=22]="onFieldError",r))(G||{});class K{constructor(){this.listenersDisable=!1,this.eventEmitter=new V.EventEmitter}disabledAllListeners(){return this.listenersDisable=!0,this}enableAllListeners(){return this.listenersDisable=!1,this}emit(e,...t){return this.listenersDisable?!1:this.eventEmitter.emit(e,t)}addListener(e,t){return this.eventEmitter.addListener(e,t),this}on(e,t){return this.eventEmitter.on(e,t),this}once(e,t){return this.eventEmitter.once(e,t),this}removeListener(e,t){return this.eventEmitter.removeListener(e,t),this}off(e,t){return this.eventEmitter.off(e,t),this}removeAllListeners(e){return this.eventEmitter.removeAllListeners(e),this}}class Q{constructor(e,t,i){this.grandTotalRecords=0,this.currentPageIndex=0,this.totalPages=0,this.pageSize=0,this.currentRecordIndex=-1,this.oldRecordIndex=-1,this.listeners=new Set,this.listenersDisable=!1,this.inserting=!1,this.active=!1,this.editing=!1,this.lastDataChangedAt=new Date().getTime(),this.lastDataBrowsingOn=new Date().getTime(),this.defaultSortFields=[],this.publishEventErrors=s=>{s.forEach(n=>{n.fieldName?(this.emitter.emit("onFieldError",n.fieldName,n.errorMessage),this.emit({type:22,fieldName:n.fieldName,error:n.errorMessage,originalError:n})):this.publishEventError(n.errorMessage,n)})},this.publishEventError=(s,n)=>{this.emitter.emit("onError",s),this.emit({type:21,error:s,originalError:n})},this.name=e,this.label=i||e,this.records=[],this.filteredRecords=[],this.loadOptions(t),this.fieldEventListeners={},this.emitter=new K,this.uuid=R.uniqueId(),this.validator=t.validator}loadOptions(e){this.records=e.records,this.filters=[],e.filters&&(this.filters=e.filters),this.currentRecord=void 0,this.currentRecordIndex=-1,this.filteredRecords=this.applyFilters(),this.filteredRecords.length>0&&(this.currentRecordIndex=0,this.currentRecord=this.filteredRecords[this.currentRecordIndex]),this.grandTotalRecords=e.grandTotalRecords,this.currentPageIndex=e.currentPage,this.totalPages=e.totalPages,this.pageSize=e.pageSize,this.active=!0,this.filter=e.filter,this.sort=e.sort,this.originFilter=e.originFilter,this.originSort=e.originSort,this.originGlobalFilter=e.originGlobalFilter,this.defaultSortFields=e.defaultSortFields?e.defaultSortFields:[]}validateDataSourceActive(e){if(!this.isActive()){const t=a.t("archbase:operationNotAllowed",{dataSourceName:this.name,operation:e});throw this.publishEventError(t,{}),new h(t)}}getName(){return this.name}clear(){if(!this.isActive()){const e=a.t("archbase:operationNotAllowed",{dataSourceName:this.name,operation:"clear"});throw this.publishEventError(e,{}),new h(e)}this.emitter.emit("beforeClose"),this.emit({type:4}),this.loadOptions({records:[],totalPages:0,grandTotalRecords:0,currentPage:0,pageSize:0}),this.active=!0,this.editing=!1,this.inserting=!1,this.emitter.emit("afterOpen"),this.emit({type:7}),this.emitter.emit("dataChanged",this.records),this.emit({type:0,data:this.records}),this.emitter.emit("afterScroll"),this.emit({type:20}),this.lastDataBrowsingOn=new Date().getTime(),this.lastDataChangedAt=new Date().getTime()}open(e){this.active=!1,this.emitter.emit("beforeClose"),this.emit({type:4}),this.loadOptions(e),this.active=!0,this.emitter.emit("afterOpen"),this.emit({type:7}),this.emitter.emit("dataChanged",this.records),this.emit({type:0,data:this.records}),this.emitter.emit("afterScroll"),this.emit({type:20}),this.lastDataBrowsingOn=new Date().getTime(),this.lastDataChangedAt=new Date().getTime()}close(){this.validateDataSourceActive("close"),this.emitter.emit("beforeClose"),this.emit({type:4}),this.active=!1,this.emitter.emit("afterClose"),this.emit({type:5}),this.emitter.emit("afterScroll"),this.emit({type:20}),this.lastDataBrowsingOn=new Date().getTime(),this.lastDataChangedAt=new Date().getTime()}setData(e){this.validateDataSourceActive("setData"),this.loadOptions(e),this.emitter.emit("dataChanged",this.records),this.emit({type:0,data:this.records}),this.lastDataChangedAt=new Date().getTime()}goToPage(e){return this.validateDataSourceActive("goToPage"),this}goToRecord(e){if(this.validateDataSourceActive("goToRecord"),this.inserting||this.editing||this.isBOF()||this.isEOF()){const t=a.t("archbase:notAllowedBrowseRecords",{dataSourceName:this.name});throw this.publishEventError(t,{}),new h(t)}e<=this.getTotalRecords()-1&&(this.currentRecordIndex=e,this.emitter.emit("afterScroll"),this.emit({type:20}),this.lastDataBrowsingOn=new Date().getTime())}disabledAllListeners(){return this.listenersDisable=!0,this.emitter.disabledAllListeners(),this}enableAllListeners(){return this.listenersDisable=!1,this.emitter.enableAllListeners(),this}addFilter(e){var t;return(t=this.filters)==null||t.push(e),this}removeFilter(e){var i,s;const t=(i=this.filters)==null?void 0:i.indexOf(e);return t&&t>=0&&((s=this.filters)==null||s.splice(t,1)),this}clearFilters(){return this.filters=[],this}applyFilters(){var t;if(!this.filters||this.filters.length===0)return this.records;let e=[...this.records];return(t=this.filters)==null||t.forEach(i=>{e=e.filter(i)}),e}emit(e){if(!this.listenersDisable)for(const t of this.listeners)t(e)}append(e){if(this.validateDataSourceActive("append"),this.inserting||this.editing){const t=a.t("archbase:insertRecordIsNotAllowed",{dataSourceName:this.name});throw this.publishEventError(t,{}),new h(t)}return this.emitter.emit("beforeAppend",e),this.emit({type:8,record:e}),this.records.push(e),this.filteredRecords=this.applyFilters(),this.grandTotalRecords++,this.filteredRecords.forEach((t,i)=>{e===t&&(this.currentRecordIndex=i,this.currentRecord=this.filteredRecords[this.currentRecordIndex],this.emitter.emit("afterScroll"),this.emit({type:20}),this.lastDataBrowsingOn=new Date().getTime())}),this.emitter.emit("afterAppend",e,this.currentRecordIndex),this.emit({type:9,record:e,index:this.currentRecordIndex}),this.emitter.emit("afterScroll"),this.emit({type:20}),this.lastDataBrowsingOn=new Date().getTime(),this.lastDataChangedAt=new Date().getTime(),this.currentRecordIndex}insert(e){if(this.validateDataSourceActive("insert"),this.inserting||this.editing){const i=a.t("archbase:insertRecordIsNotAllowed",{dataSourceName:this.name});throw this.publishEventError(i,{}),new h(i)}this.emitter.emit("beforeInsert"),this.emit({type:12}),this.oldRecord=this.getCurrentRecord(),this.oldRecordIndex=this.currentRecordIndex,this.grandTotalRecords++;const t=this.getTotalRecords();return this.filteredRecords.push(e),this.currentRecordIndex=t,this.currentRecord=e,this.inserting=!0,this.emitter.emit("afterInsert",e,this.currentRecordIndex),this.emit({type:13,record:e,index:this.currentRecordIndex}),this.emitter.emit("afterScroll"),this.emit({type:20}),this.lastDataBrowsingOn=new Date().getTime(),this.lastDataChangedAt=new Date().getTime(),this}edit(){if(this.validateDataSourceActive("edit"),this.inserting||this.editing){const e=a.t("archbase:editRecordIsNotAllowed",{dataSourceName:this.name});throw this.publishEventError(e,{}),new h(e)}if(this.isEmpty()||!this.currentRecord){const e=a.t("archbase:noRecordsToEdit",{dataSourceName:this.name});throw this.publishEventError(e,{}),new h(e)}if(this.isBOF()){const e=a.t("archbase:BOFDataSource",{dataSourceName:this.name});throw this.publishEventError(e,{}),new h(e)}if(this.isEOF()){const e=a.t("archbase:EOFDataSource",{dataSourceName:this.name});throw this.publishEventError(e,{}),new h(e)}return this.emitter.emit("beforeEdit",this.currentRecord,this.currentRecordIndex),this.emit({type:14,record:this.currentRecord,index:this.getCurrentIndex()}),this.editing=!0,this.currentRecord=R.cloneDeep(this.currentRecord),this.emitter.emit("afterEdit",this.currentRecord,this.getCurrentIndex()),this.emit({type:15,record:this.currentRecord,index:this.getCurrentIndex()}),this}async remove(e){if(this.validateDataSourceActive("remove"),this.inserting||this.editing){const n=a.t("archbase:removingRecordIsNotAllowed",{dataSourceName:this.name});throw this.publishEventError(n,{}),new h(n)}if(this.isEmpty()||!this.currentRecord){const n=a.t("archbase:noRecordsToEdit",{dataSourceName:this.name});throw this.publishEventError(n,{}),new h(n)}if(this.isBOF()){const n=a.t("archbase:BOFDataSource",{dataSourceName:this.name});throw this.publishEventError(n,{}),new h(n)}if(this.isEOF()){const n=a.t("archbase:EOFDataSource",{dataSourceName:this.name});throw this.publishEventError(n,{}),new h(n)}this.emitter.emit("beforeRemove",this.currentRecord,this.currentRecordIndex),this.emit({type:10,record:this.currentRecord,index:this.getCurrentIndex()});let t=-1;const i=this.currentRecord,s=this.currentRecordIndex;return this.records.forEach((n,o)=>{this.currentRecord===n&&(t=o)}),t>=0&&this.records.splice(t,1),this.records!==this.filteredRecords&&this.filteredRecords.splice(this.getCurrentIndex(),1),this.grandTotalRecords--,this.filteredRecords.length===0?(this.currentRecord=void 0,this.currentRecordIndex=-1):(this.currentRecordIndex>this.filteredRecords.length-1&&this.currentRecordIndex--,this.currentRecord=this.filteredRecords[this.currentRecordIndex]),this.editing=!1,this.inserting=!1,this.emitter.emit("afterScroll"),this.emit({type:20}),this.emitter.emit("afterRemove",i,s),this.emit({type:11,record:i,index:s}),this.lastDataBrowsingOn=new Date().getTime(),this.lastDataChangedAt=new Date().getTime(),e&&e(),i}isBrowsing(){return!this.isEditing()&&!this.isInserting()&&this.isActive()}isEditing(){return this.editing}isInserting(){return this.inserting}isActive(){return this.active}getPageSize(){return this.pageSize}validate(){if(this.validator&&this.currentRecord){const e=this.validator.validateEntity(this.currentRecord);if(e&&e.length>0)if(this.publishEventErrors(e),e[0].fieldName){const t=a.t("archbase:errorSavingRecord",{dataSourceName:this.label});throw new h(t)}else throw new h(e[0].errorMessage)}return!0}async save(e){if(this.validateDataSourceActive("save"),!this.inserting&&!this.editing){const i=a.t("archbase:saveRecordIsNotAllowed",{dataSourceName:this.name});throw this.publishEventError(i,{}),new h(i)}if(!this.currentRecord){const i=a.t("archbase:noRecordToSave",{dataSourceName:this.name});throw this.publishEventError(i,{}),new h(i)}if(this.emitter.emit("beforeSave",this.currentRecord,this.getCurrentIndex()),this.emit({type:16,record:this.currentRecord,index:this.getCurrentIndex()}),this.validator){const i=this.validator.validateEntity(this.currentRecord);if(i&&i.length>0)if(this.publishEventErrors(i),i[0].fieldName){const s=a.t("archbase:errorSavingRecord",{dataSourceName:this.label});throw new h(s)}else throw new h(i[0].errorMessage)}this.editing&&(this.filteredRecords[this.getCurrentIndex()]=this.currentRecord);let t=-1;return this.records.forEach((i,s)=>{i===this.currentRecord&&(t=s)}),t>=0?this.records[t]=this.currentRecord:this.records.push(this.currentRecord),this.editing=!1,this.inserting=!1,this.lastDataChangedAt=new Date().getTime(),this.emitter.emit("afterSave",this.currentRecord,this.getCurrentIndex()),this.emit({type:17,record:this.currentRecord,index:this.getCurrentIndex()}),e&&e(),this.currentRecord}cancel(){if(this.validateDataSourceActive("cancel"),!this.inserting&&!this.editing){const e=a.t("archbase:notAllowCancelRecord",{dataSourceName:this.name});throw this.publishEventError(e,{}),new h(e)}return this.emitter.emit("beforeCancel",this.currentRecord,this.currentRecordIndex),this.emit({type:18,record:this.currentRecord,index:this.getCurrentIndex()}),this.inserting?(this.filteredRecords.splice(this.currentRecordIndex,1),this.currentRecord=this.oldRecord,this.currentRecordIndex=this.oldRecordIndex,this.grandTotalRecords--,this.emitter.emit("afterScroll"),this.emit({type:20}),this.lastDataBrowsingOn=new Date().getTime()):this.currentRecord=this.filteredRecords[this.currentRecordIndex],this.inserting=!1,this.editing=!1,this.emitter.emit("afterCancel",this.currentRecord,this.currentRecordIndex),this.emit({type:19,record:this.currentRecord,index:this.getCurrentIndex()}),this.lastDataChangedAt=new Date().getTime(),this}getCurrentPage(){return this.currentPageIndex}getTotalPages(){return this.totalPages}getTotalRecords(){return this.filteredRecords.length}getGrandTotalRecords(){return this.grandTotalRecords}getFieldValue(e,t=""){if(this.validateDataSourceActive("getFieldValue"),!e){const n=a.t("archbase:invalidFieldName",{dataSourceName:this.name});throw this.publishEventError(n,{}),new h(n)}if(this.isEmpty()||this.isBOF()||this.isEOF()&&!this.inserting)return;let i=this.filteredRecords[this.currentRecordIndex];this.editing&&(i=this.currentRecord);let s=this.fieldValueByName(i,e);return s===void 0&&t!==void 0&&(s=t),s}fieldValueByName(e,t){if(e===void 0)return;const i=p.getNestedProperty(e,t);if(i!==void 0)return w(i)?E(i):i}setFieldValue(e,t){if(this.validateDataSourceActive("setFieldValue"),this.isEmpty()||!this.currentRecord)return this;if(!(this.inserting||this.editing||this.isBOF()||this.isEOF())){const o=a.t("archbase:recordNotBeingEdited",{dataSourceName:this.name});throw this.publishEventError(o,{}),new h(o)}let i=t;const s=p.getNestedProperty(this.currentRecord,e);return w(t)&&(i=E(t)),e.split(".").length>1?p.setNestedProperty(this.currentRecord,e,i):this.currentRecord[e]=i,this.lastDataChangedAt=new Date().getTime(),this.emitFieldChangeEvent(e,s,i),this.emitter.emit("fieldChanged",this.currentRecord,this.getCurrentIndex(),e,s,i),this.emit({type:3,record:this.currentRecord,index:this.getCurrentIndex(),fieldName:e,oldValue:s,newValue:i}),this}isEmptyField(e){return this.validateDataSourceActive("isEmptyField"),this.getFieldValue(e)===void 0||this.getFieldValue(e,"")===""}getOptions(){return{pageSize:this.getPageSize(),currentPage:this.getCurrentPage(),records:this.records,filters:this.filters,grandTotalRecords:this.getGrandTotalRecords(),totalPages:this.getTotalPages(),filter:this.filter,sort:this.sort,originFilter:this.originFilter,originSort:this.originSort,originGlobalFilter:this.originGlobalFilter}}refreshData(e){if(e)this.emitter.emit("refreshData",e),this.emit({type:2,options:e});else{const t=this.getOptions();this.emitter.emit("refreshData",t),this.emit({type:2,options:t})}this.lastDataBrowsingOn=new Date().getTime(),this.lastDataChangedAt=new Date().getTime()}browseRecords(){return this.filteredRecords}getCurrentIndex(){return this.currentRecordIndex}getCurrentRecord(){return this.currentRecord}isEOF(){return this.currentRecordIndex>this.getTotalRecords()-1||this.isEmpty()}isBOF(){return this.currentRecordIndex===-1}isEmpty(){return this.getTotalRecords()===0}isFirst(){return this.currentRecordIndex===0}isLast(){return this.currentRecordIndex===this.getTotalRecords()-1}next(){if(this.validateDataSourceActive("next"),this.inserting||this.editing||this.isBOF()||this.isEOF()){const e=a.t("archbase:notAllowedBrowseRecords",{dataSourceName:this.name});throw this.publishEventError(e,{}),new h(e)}return this.currentRecordIndex+1>this.getTotalRecords()-1?(this.currentRecordIndex++,this.currentRecord=void 0):(this.currentRecordIndex++,this.currentRecord=this.filteredRecords[this.currentRecordIndex],this.emitter.emit("afterScroll"),this.emit({type:20}),this.lastDataBrowsingOn=new Date().getTime()),this}prior(){if(this.validateDataSourceActive("prior"),!this.inserting||!this.editing||this.isBOF()||this.isEOF()){const e=a.t("archbase:notAllowedBrowseRecords",{dataSourceName:this.name});throw this.publishEventError(e,{}),new h(e)}return this.currentRecordIndex-1<0?(this.currentRecordIndex=-1,this.currentRecord=void 0):(this.currentRecordIndex--,this.currentRecord=this.filteredRecords[this.currentRecordIndex],this.emitter.emit("afterScroll"),this.emit({type:20}),this.lastDataBrowsingOn=new Date().getTime()),this}first(){if(this.validateDataSourceActive("first"),this.inserting||this.editing){const e=a.t("archbase:notAllowedBrowseRecords",{dataSourceName:this.name});throw this.publishEventError(e,{}),new h(e)}return this.getTotalRecords()===0?(this.currentRecordIndex=-1,this.currentRecord=void 0):(this.currentRecordIndex=0,this.currentRecord=this.filteredRecords[this.currentRecordIndex],this.emitter.emit("afterScroll"),this.emit({type:20}),this.lastDataBrowsingOn=new Date().getTime()),this}last(){if(this.validateDataSourceActive("last"),this.inserting||this.editing){const e=a.t("archbase:notAllowedBrowseRecords",{dataSourceName:this.name});throw this.publishEventError(e,{}),new h(e)}return this.getTotalRecords()===0?(this.currentRecordIndex=-1,this.currentRecord=void 0):(this.currentRecordIndex=this.getTotalRecords()-1,this.currentRecord=this.filteredRecords[this.currentRecordIndex],this.emitter.emit("afterScroll"),this.emit({type:20}),this.lastDataBrowsingOn=new Date().getTime()),this}gotoRecord(e){if(e===this.currentRecordIndex)return this.currentRecord;if(this.validateDataSourceActive("gotoRecord"),this.inserting||this.editing||this.isBOF()||this.isEOF()){const t=a.t("archbase:notAllowedBrowseRecords",{dataSourceName:this.name});throw this.publishEventError(t,{}),new h(t)}if(e<0||e>=this.filteredRecords.length){const t="Indice fora da faixa.";throw this.publishEventError(t,{}),new h(t)}return this.currentRecordIndex=e,this.currentRecord=this.filteredRecords[this.currentRecordIndex],this.emitter.emit("afterScroll"),this.emit({type:20}),this.lastDataBrowsingOn=new Date().getTime(),this.currentRecord}gotoRecordByData(e){if(this.validateDataSourceActive("gotoRecordByData"),this.inserting||this.editing||this.isBOF()||this.isEOF()){const i=a.t("archbase:notAllowedBrowseRecords",{dataSourceName:this.name});throw this.publishEventError(i,{}),new h(i)}if(this.isEmpty())return!1;if(this.currentRecord===e)return this.emitter.emit("afterScroll"),this.emit({type:20}),this.lastDataBrowsingOn=new Date().getTime(),!0;let t=!1;return this.filteredRecords.forEach((i,s)=>{e===i&&(this.currentRecordIndex=s,this.currentRecord=i,this.emitter.emit("afterScroll"),this.emit({type:20}),this.lastDataBrowsingOn=new Date().getTime(),t=!0)}),t}locate(e){if(!this.isBrowsing()){const s=a.t("archbase:notAllowedBrowseRecords",{dataSourceName:this.name});throw this.publishEventError(s,{}),new h(s)}if(this.isEmpty())return!1;let t=-1,i=-1;return this.records.forEach(s=>{i++;for(const n in e)this.fieldValueByName(s,n)===e[n]&&(t=i)}),t>=0&&this.gotoRecord(t),t>=0}locateByFilter(e){if(this.validateDataSourceActive("locate"),this.inserting||this.editing){const i=a.t("archbase:notAllowedBrowseRecords",{dataSourceName:this.name});throw this.publishEventError(i,{}),new h(i)}if(this.isEmpty())return!1;const t=this.filteredRecords.findIndex(e);return t!==-1&&this.gotoRecord(t),t>=0}addListener(e){return this.listeners.has(e)||this.listeners.add(e),this}removeListener(e){return this.listeners.has(e)&&this.listeners.delete(e),this}on(e,t){this.emitter.on(e,t)}off(e,t){this.emitter.off(e,t)}addFieldChangeListener(e,t){const i=e.split(".");let s="";return i.forEach((n,o)=>{s=o===0?n:`${s}.${n}`,this.fieldEventListeners[`field:${s}`]||(this.fieldEventListeners[`field:${s}`]=[]),this.fieldEventListeners[`field:${s}`].includes(t)||this.fieldEventListeners[`field:${s}`].push(t)}),this}removeFieldChangeListener(e,t){const i=e.split(".");let s="";return i.forEach((n,o)=>{s=o===0?n:`${s}.${n}`;const c=this.fieldEventListeners[`field:${s}`];if(c){const l=c.indexOf(t);l!==-1&&c.splice(l,1)}}),this}emitFieldChangeEvent(e,t,i){const s=e.split(".");let n="";for(const o of s){n=n?`${n}.${o}`:o;const c=this.fieldEventListeners[`field:${n}`];c&&c.forEach(l=>l(n,t,i))}}}const X=r=>{const e=i=>{i.addListener(r.listener)},t=i=>{i.removeListener(r.listener)};D.useEffect(()=>(r.dataSource&&(t(r.dataSource),e(r.dataSource)),()=>{r.dataSource&&t(r.dataSource)}),[r.dataSource.uuid])};export{Q as A,G as D,J as a,h as b,p as i,X as u};
